{{- /* helper: only the data block */ -}}
{{ define "common.configmap.data" }}
  SPRING_PROFILES_ACTIVE: {{ .Values.global.activeProfile }}
  SPRING_CONFIG_IMPORT: "optional:configserver:{{ .Values.global.configServerURL }}"
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: {{ .Values.global.eurekaServerURL }}
  SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK-SET-URI: {{ .Values.global.keyCloakURL }}
  JAVA_TOOL_OPTIONS: {{ .Values.global.openTelemetryJavaAgent }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.global.otelExporterEndPoint }}
  OTEL_METRICS_EXPORTER: {{ .Values.global.otelMetricsExporter }}
  OTEL_LOGS_EXPORTER: {{ .Values.global.otelLogsExporter }}
  SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: {{ .Values.global.kafkaBrokerURL }}
  # build/version and message broker settings
  BUILD_VERSION: "{{ .Values.global.buildVersion | default "1.0.0" }}"
  SPRING_RABBITMQ_HOST: "{{ .Values.global.rabbitmqHost | default "rabbitmq" }}"
  SPRING_RABBITMQ_PORT: "{{ .Values.global.rabbitmqPort | default "5672" }}"
  SPRING_RABBITMQ_USERNAME: "{{ .Values.global.rabbitmqUsername | default "guest" }}"
  SPRING_RABBITMQ_PASSWORD: "{{ .Values.global.rabbitmqPassword | default "guest" }}"
  # service-specific datasource URLs (generated dynamically)
  # Includes non-DB services too so Helm envFrom/configMapKeyRef lookups never fail
{{- $srv := dict
      "ACCOUNTS"     (.Values.global.accountsDBHost      | default "accountsdb")
      "LOANS"        (.Values.global.loansDBHost         | default "loansdb")
      "CARDS"        (.Values.global.cardsDBHost         | default "cardsdb")
      "CONFIGSERVER" (.Values.global.configserverDBHost  | default "localhost")
      "EUREKASERVER" (.Values.global.eurekaserverDBHost  | default "localhost")
      "GATEWAYSERVER"(.Values.global.gatewayserverDBHost | default "localhost")
      "MESSAGE"      (.Values.global.messageDBHost       | default "localhost")
    -}}
{{- range $k, $v := $srv }}
  {{ printf "SPRING_DATASOURCE_URL_%s" $k }}: "jdbc:mysql://{{ $v }}:3306/{{ $v }}"
{{- end }}
  SPRING_DATASOURCE_USERNAME: "{{ .Values.global.dbUsername | default "root" }}"
  SPRING_DATASOURCE_PASSWORD: "{{ .Values.global.dbPassword | default "root" }}"
{{ end }}

{{/* full ConfigMap wrapper (for backward compatibility) */}}
{{ define "common.configmap" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.global.configMapName }}
data:
{{ include "common.configmap.data" . | indent 2 }}
{{ end }}